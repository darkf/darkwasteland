<!doctype html>
<html>
<body>
<canvas id="canvas" width="800" height="640" style="border:1px solid black"></canvas>

<script src="util.js"></script>
<script src="tileset.js"></script>
<script src="game.js"></script>
<script src="map.js"></script>
<script>
const SCREEN_WIDTH = 800, SCREEN_HEIGHT = 640;
const DIR_UP = 0, DIR_DOWN = 1, DIR_LEFT = 2, DIR_RIGHT = 3;
const MAP_SCALE = 2;
const camera = {x: 0, y: 0};
const velocity = {x: 0, y: 0};
const ctx = document.getElementById("canvas").getContext("2d");
let game, map;
let dirty = true;

ctx.imageSmoothingEnabled = false; // disable image filtering/AA

function centerCamera(tilePos) {
	camera.x = tilePos.x*16*MAP_SCALE - SCREEN_WIDTH/2|0;
	camera.y = tilePos.y*16*MAP_SCALE - SCREEN_HEIGHT/2|0;
}

function draw() {
	ctx.fillStyle = "white";
	ctx.fillRect(0, 0, 800, 640);

	ctx.save();
	ctx.translate(-camera.x, -camera.y);
	ctx.scale(MAP_SCALE, MAP_SCALE);
	for(let y = 0; y < map.size; y++) {
		for(let x = 0; x < map.size; x++) {
			const tileImage = getTileImage(map.tilemap[y][x]);
			ctx.drawImage(tileImage, x*16, y*16);

			if(x === game.partyPos.x && y === game.partyPos.y) { // draw party
				console.log("party @", x, y)
				ctx.drawImage(getSpriteImage(7), x*16, y*16);
			}
		}
	}
	ctx.restore();
}

function tick() {
	if(dirty || velocity.x !== 0 || velocity.y !== 0) {
		camera.x += velocity.x;
		camera.y += velocity.y;

		draw();
		dirty = false;
	}

	window.requestAnimationFrame(tick);
}

function dirToVec(dir) {
	switch(dir) {
		case DIR_LEFT: return {x: -1, y: 0};
		case DIR_RIGHT: return {x: 1, y: 0};
		case DIR_UP: return {x: 0, y: -1};
		case DIR_DOWN: return {x: 0, y: 1};
		default: throw new Error("");
	}
}

function moveParty(dir) {
	gameMoveParty(game, dir);
	dirty = true;
}

document.onkeydown = function(e) {
	switch(e.keyCode) {
		// camera controls
		case 39: velocity.x = 1; break; // right
		case 37: velocity.x = -1; break; // left
		case 38: velocity.y = -1; break; // up
		case 40: velocity.y = 1; break; // down

		// movement controls
		case 87: moveParty(DIR_UP); break; // W
		case 65: moveParty(DIR_LEFT); break; // A
		case 83: moveParty(DIR_DOWN); break; // S
		case 68: moveParty(DIR_RIGHT); break; // D

		default: console.log(e.keyCode);
	}
}

document.onkeyup = function(e) {
	switch(e.keyCode) {
		case 39: case 37: velocity.x = 0; break; // right/left
		case 38: case 40: velocity.y = 0; break; // up/down
	}
}

function load() {
	preloadSprites(function() {
		requestXML("data/gamedata1/savegame.xml", function(xml) {
			gameFromXML(xml, function(_game) {
				game = _game;
				map = game.map;

				console.log("map: %o", map);
				loadMapData(map, function() {
					centerCamera(game.partyPos);
					draw();
					tick();
				})
			})
		});
	});
}

load();
</script>
</body>
</html>